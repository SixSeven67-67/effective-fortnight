name: VPS Webtop 14GB - Cloudflare (6 Horas)

on:
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-latest
    # Tiempo límite estricto de GitHub: 6 horas (360 min)
    timeout-minutes: 360
    
    steps:
      - name: "1. Preparar Entorno"
        uses: actions/checkout@v4

      - name: "2. Desplegar Webtop (Budgie - Privileged)"
        run: |
          # Iniciamos Webtop en segundo plano (-d)
          # USAMOS --privileged: Obligatorio para Flatpak, Sober y Wine
          docker run -d \
            --name=webtop \
            --privileged \
            --security-opt seccomp=unconfined \
            -e PUID=1000 -e PGID=1000 \
            -e TZ=America/Caracas \
            -p 3000:3000 \
            --memory="14g" \
            --memory-swap="14g" \
            --shm-size="4gb" \
            lscr.io/linuxserver/webtop:ubuntu-budgie
            
          echo "Webtop (Budgie) arrancando..."
          sleep 15

      - name: "3. Configurar Tienda, Wine y Sober (Roblox)"
        run: |
          echo "Instalando paquetes y Sober..."
          # Ejecutamos comandos como root dentro del contenedor
          docker exec -u 0 webtop bash -c "
            # 1. Actualizar repositorios
            apt-get update
            
            # 2. Instalar Flatpak y Tienda de Software (Gnome Software)
            apt-get install -y flatpak gnome-software gnome-software-plugin-flatpak
            
            # 3. Configurar Flathub (Fuente de apps y Sober)
            flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
            
            # 4. Instalar Wine (32 y 64 bits) para otros programas .exe
            dpkg --add-architecture i386
            apt-get update
            apt-get install -y wine64 wine32
            
            # 5. Instalar SOBER (Roblox)
            # Sober corre la versión estable de Roblox en Linux
            flatpak install -y flathub org.vinegarhq.Sober
            
            # Limpieza básica
            apt-get clean
          "
          echo "Instalación de Sober y herramientas completada."

      - name: "4. Crear Túnel Cloudflare (Mantener Vivo)"
        run: |
          echo "---------------------------------------------------------"
          echo " INSTRUCCIONES:"
          echo " 1. Espera a que carguen los logs abajo."
          echo " 2. Busca la URL que termina en 'trycloudflare.com'."
          echo " 3. Entra a esa URL para ver tu escritorio."
          echo "---------------------------------------------------------"
          echo " NOTA: Para jugar Roblox, busca 'Sober' en el menú de inicio."
          echo " NOTA: Usa 'Software' (la bolsa de compras) para instalar más apps."
          echo "---------------------------------------------------------"
          
          # Túnel Cloudflare manteniendo la sesión viva
          docker run --rm --net=host cloudflare/cloudflared:latest tunnel --url http://localhost:3000
